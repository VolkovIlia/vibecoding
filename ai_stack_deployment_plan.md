# Финальный Детализированный План Разработки и Документирования Скрипта Автоматического Развертывания AI-Инструментов (с чек-листом)

**Статус:** Частично реализовано. Готовится к передаче для дальнейшей разработки.

## Чек-лист Выполненных Задач:

*   [x] **Планирование и Анализ:**
    *   [x] Сбор первоначальных требований.
    *   [x] Анализ проекта-примера (`local-ai-packaged`).
    *   [x] Составление и утверждение детального плана.
    *   [x] Создание этого документа (`ai_stack_deployment_plan.md`).
*   [x] **Этап 1: Подготовка VPS и базовые настройки (Ansible)**
    *   [x] **1.1. Ansible-проект:** Создана структура (плейбук, инвентарь, роли `common`, `docker`, `app_stack`).
    *   [x] **1.2. ОС:** Запланировано для Ubuntu 22.04 LTS.
    *   [x] **1.3. Система (роль `common`):** Реализовано обновление, установка базовых пакетов (включая `git`, `ufw`).
    *   [x] **1.4. Пользователь (роль `common` и `playbook.yml`):** Реализовано создание пользователя с паролем (запрашивается) и правами `sudo`.
    *   [x] **1.5. Безопасность (роль `common`):** Реализована базовая настройка `ufw` (SSH, HTTP, HTTPS).
*   [x] **Этап 2: Развертывание приложений с помощью Docker Compose (Ansible)**
    *   [x] **2.1. Директория проекта на VPS (роль `app_stack`):** Реализовано создание `/opt/ai_stack`.
    *   [x] **2.2. Шаблон `docker-compose.yml.j2` (роль `app_stack`):**
        *   [x] **Сервисы:** Определены Caddy, Ollama, OpenWebUI, Qdrant, Flowise, n8n, SearXNG.
        *   [x] **Supabase (интегрированный):** Определены основные сервисы (db, kong, gotrue, realtime, storage, meta, edge_functions).
        *   [x] **Langfuse (интегрированный):** Определены все сервисы (postgres, clickhouse, minio, valkey/redis, worker, web).
        *   [x] **Образы:** Используются переменные из `defaults/main.yml`.
        *   [x] **Переменные окружения:** Управление через Ansible (vars_prompt, defaults, шаблоны `.env.j2`).
        *   [x] **Docker Volumes:** Определены для всех сервисов.
        *   [x] **Сеть:** Определена общая Docker-сеть `ai_stack_network`.
        *   [x] **Ollama:** Реализована конфигурация для профилей CPU/GPU.
        *   [x] **Инициализация Ollama:** Реализована загрузка моделей.
        *   [ ] **Инициализация n8n:** (Опциональный импорт workflows/credentials - **НЕ РЕАЛИЗОВАНО**)
        *   [x] `restart: unless-stopped` для сервисов.
    *   [x] **2.3. Ansible-роль `app_stack`:**
        *   [x] Копирование `docker-compose.yml.j2`, `Caddyfile.j2`, `.env.j2`.
        *   [x] Создание директорий для томов (косвенно, через Docker).
        *   [x] Запуск `docker-compose -p ai_stack up -d`.
        *   [x] Идемпотентность (частично, требует полного тестирования).
*   [x] **Этап 3: Настройка Caddy как реверс-прокси (Ansible)**
    *   [x] **3.1. Интерактивный выбор (playbook.yml):** Использовать домен (да/нет).
    *   [x] **3.2. С доменом (Caddyfile.j2):** Генерация с поддоменами и авто-SSL.
    *   [x] **3.3. Без домена (Caddyfile.j2):** Проксирование на HTTP по IP:порт.
    *   [x] **3.4. Caddy в Docker-сети (docker-compose.yml.j2):** Проксирование на имена сервисов.
    *   [x] **3.5. Расширенная конфигурация для SearXNG (Caddyfile.j2):** Реализованы заголовки безопасности и кэширование.
*   [x] **Этап 4: Специфические настройки и инициализация (Ansible)**
    *   [x] **4.1. Генерация секрета SearXNG (роль `app_stack`):** Реализовано.
    *   [x] **4.2. Обработка `cap_drop` для SearXNG (роль `app_stack` и `docker-compose.yml.j2`):** Реализована автоматизация.
    *   [ ] **4.3. Ожидание инициализации Supabase:** (**НЕ РЕАЛИЗОВАНО**)
*   [x] **Этап 5: Взаимодействие сервисов**
    *   [x] Конфигурация через переменные окружения в `docker-compose.yml.j2` для использования имен сервисов Docker (реализовано для большинства сервисов).
*   [ ] **Этап 6: Персистентность данных и Резервное копирование (Ansible, опционально)**
    *   [x] **6.1. Персистентность:** Docker-volumes (определены).
    *   [ ] **6.2. Резервное копирование:** (**НЕ РЕАЛИЗОВАНО**)
*   [ ] **Этап 7: Обновление и Обслуживание (Ansible)**
    *   [ ] **7.1. Обновление приложений:** (**НЕ РЕАЛИЗОВАНО**)
    *   [ ] **7.2. Обслуживание (документация):** (**НЕ РЕАЛИЗОВАНО**)
*   [ ] **Этап 8: Тестирование и отладка**
    *   [ ] Тщательное тестирование плейбука.
    *   [ ] Проверка конфигураций, доступа к сервисам.
    *   [ ] **Создание базовых скриптов/инструкций для smoke-тестирования.** (**НОВЫЙ ПУНКТ**)
*   [ ] **Этап 9: Управление версиями (Git)** (**НОВЫЙ ПУНКТ**)
    *   [ ] Инициализация Git-репозитория.
    *   [ ] Создание `.gitignore`.
    *   [ ] Первый коммит с текущим состоянием проекта.
*   [ ] **Этап 0: Создание Подробного Мануала (Документация)**
    *   [ ] Написание всех разделов мануала.

---
## Исходный План (до детализации с чек-листом):

## 0. Создание Подробного Мануала (Документация)

*   **0.1. Цель проекта:** Разработать Ansible-скрипт для простого и быстрого развертывания интегрированного стека AI-инструментов на VPS.
*   **0.2. Целевая аудитория:** Пользователи с различным уровнем технической подготовки, желающие развернуть AI-среду.
*   **0.3. Структура и содержание мануала:**
    *   **Введение:** Краткое описание решения и его возможностей.
    *   **Требования:**
        *   К VPS: Ubuntu 22.04 LTS. Рекомендации по ресурсам (CPU, RAM, Disk), особенно с учетом запуска Ollama с небольшими моделями эмбеддинга.
        *   К управляющей машине: Установленный Ansible.
        *   (Если используется домен) Настроенная DNS A-запись, указывающая на IP-адрес VPS.
    *   **Установка и настройка:**
        *   Клонирование репозитория с Ansible-скриптами.
        *   Конфигурация инвентарного файла Ansible (указание IP VPS).
        *   Запуск плейбука: команда для запуска.
        *   Интерактивные запросы во время выполнения:
            *   Выбор имени пользователя для VPS.
            *   Ввод и подтверждение пароля для нового пользователя.
            *   Выбор: использовать ли собственный домен для доступа к сервисам (да/нет).
            *   Если "да" на предыдущий вопрос: ввод основного доменного имени.
    *   **Доступ к сервисам:**
        *   Таблица с URL-адресами или IP:порт для каждого развернутого приложения (в зависимости от выбора "с доменом" / "без домена").
        *   Примеры учетных данных по умолчанию (если применимо и безопасно).
    *   **Первоначальная настройка приложений (примеры):**
        *   Как загрузить первую модель в Ollama (например, небольшую модель для эмбеддингов типа `all-minilm`).
        *   Краткие советы по началу работы с n8n, Flowise, OpenWebUI, Supabase, Langfuse.
    *   **Обслуживание:**
        *   Проверка статуса сервисов.
        *   Просмотр логов.
        *   Инструкции по обновлению стека.
        *   Инструкции по резервному копированию данных.
    *   **Устранение неисправностей:** Частые проблемы и их решения.
    *   **Структура проекта:** Описание файлов и директорий в репозитории.

## Этап 1: Подготовка VPS и базовые настройки (Ansible)

*   **1.1. Ansible-проект:** Структура (плейбук, инвентарь, роли `common`, `docker`, `app_stack`).
*   **1.2. ОС:** Ubuntu 22.04 LTS (`apt`).
*   **1.3. Система:** Обновление, установка Docker, Docker Compose, Python, git, curl, ufw.
*   **1.4. Пользователь (интерактивно):** Имя, пароль, `sudo`.
*   **1.5. Безопасность:** `ufw` (SSH, HTTP, HTTPS).

## Этап 2: Развертывание приложений с помощью Docker Compose (Ansible)

*   **2.1. Директория проекта на VPS:** `/opt/ai_stack`.
*   **2.2. Шаблон `docker-compose.yml.j2`:**
    *   **Сервисы:** n8n, SearXNG, Flowise, Qdrant, Caddy, OpenWebUI, Ollama.
    *   **Supabase (интегрированный):** Все необходимые сервисы Supabase (kong, gotrue, db, meta, storage, realtime и т.д.) будут определены в этом же файле на основе официальной self-hosted конфигурации.
    *   **Langfuse (интегрированный):** Все необходимые сервисы Langfuse (langfuse-worker, langfuse-web, postgres, clickhouse, minio, valkey/redis) будут определены здесь.
    *   **Образы:** Официальные, с версиями.
    *   **Переменные окружения:** Управление через Ansible (vars, vault, `vars_prompt`).
    *   **Docker Volumes:** Именованные тома для всех персистентных данных.
    *   **Сеть:** Общая Docker-сеть `ai_stack_network`.
    *   **Ollama:** Конфигурация для небольших моделей, профили CPU/GPU (управляется переменной `ollama_profile` в Ansible, которая влияет на секцию `deploy` сервиса Ollama).
    *   **Инициализация Ollama:** Опциональная загрузка моделей при первом запуске (управляется переменными Ansible).
    *   **Инициализация n8n:** Опциональный импорт workflows/credentials (управляется переменными Ansible).
    *   `restart: unless-stopped`.
*   **2.3. Ansible-роль `app_stack`:**
    *   Копирование `docker-compose.yml.j2`, `Caddyfile.j2`, `.env.j2` (если используется).
    *   Создание директорий для томов.
    *   Запуск `docker-compose -p ai_stack up -d`.
    *   Идемпотентность.

## Этап 3: Настройка Caddy как реверс-прокси (Ansible)

*   **3.1. Интерактивный выбор:** Использовать домен (да/нет).
*   **3.2. С доменом:** Запрос домена, генерация `Caddyfile.j2` с поддоменами и авто-SSL. Инструкции по DNS в мануале.
*   **3.3. Без домена:** Caddy проксирует на HTTP по IP:порт (например, `http://<VPS_IP>:8001` -> n8n). `Caddyfile.j2` генерируется без TLS.
*   **3.4. Caddy в Docker-сети:** Не `network_mode: host`. Проксирование на имена сервисов Docker.
*   **3.5. Расширенная конфигурация для SearXNG:** Заголовки безопасности, кэширование (адаптировано из примера).

## Этап 4: Специфические настройки и инициализация (Ansible)

*   **4.1. Генерация секрета SearXNG:** Ansible генерирует ключ и обновляет `searxng/settings.yml` (скопированный из `settings-base.yml`).
*   **4.2. Обработка `cap_drop` для SearXNG (автоматизация):**
    *   Ansible-задачи для проверки первого запуска SearXNG.
    *   Условная модификация `docker-compose.yml.j2` (комментирование/раскомментирование `cap_drop`).
    *   Запуск/перезапуск SearXNG.
*   **4.3. Ожидание инициализации Supabase:** Использование Ansible `wait_for` перед запуском зависимых сервисов.

## Этап 5: Взаимодействие сервисов

*   Конфигурация через переменные окружения в `docker-compose.yml.j2` для использования имен сервисов Docker.

## Этап 6: Персистентность данных и Резервное копирование (Ansible, опционально)

*   **6.1. Персистентность:** Docker-volumes.
*   **6.2. Резервное копирование (отключено по умолчанию, настраивается):**
    *   Ansible-переменные для включения, пути, частоты.
    *   Ansible-задачи для создания скрипта бэкапа (архивация Docker-volumes).
    *   Ansible-задачи для настройки `cron`-задания.
    *   Инструкции в мануале.

## Этап 7: Обновление и Обслуживание (Ansible)

*   **7.1. Обновление приложений:** Ansible-тег/плейбук для `docker-compose pull` и `docker-compose up -d`.
*   **7.2. Обслуживание:** Инструкции в мануале (логи, статус).

## Этап 8: Тестирование и отладка

*   Тщательное тестирование плейбука на чистом VPS Ubuntu 22.04 LTS.
*   Проверка всех конфигураций, интерактивных запросов, доступа к сервисам.

## Диаграммы Mermaid

### Общая архитектура развертывания:
```mermaid
graph TD
    A[Пользователь/Администратор] -- Ansible --> B(VPS Ubuntu);
    subgraph VPS Ubuntu
        C(Ansible Engine - задачи) --> D{Docker Engine};
        D --> E[Docker Compose];
        E -- управляет --> F((Общая Docker Сеть ai_stack_network));

        subgraph "Docker Контейнеры"
            direction LR
            CaddyService[Caddy] <--> F;
            N8NService[n8n] <--> F;
            SearXNGService[SearXNG] <--> F;
            FlowiseService[Flowise] <--> F;
            SupabaseStack[Supabase (несколько сервисов)] <--> F;
            QdrantService[Qdrant] <--> F;
            OpenWebUIService[OpenWebUI] <--> F;
            OllamaService[Ollama] <--> F;
            LangfuseStack[Langfuse (несколько сервисов)] <--> F;
        end

        CaddyService -- HTTPS/HTTP (внешний доступ) --> O{Интернет};
    end

    Volumes[Docker Volumes на хосте] -. данные .-> SupabaseStack;
    Volumes -. данные .-> QdrantService;
    Volumes -. данные .-> OllamaService;
    Volumes -. данные .-> N8NService;
    Volumes -. данные .-> FlowiseService;
    Volumes -. данные .-> CaddyService;
    Volumes -. данные .-> LangfuseStack;
    Volumes -. данные .-> OpenWebUIService;
```

### Пример взаимодействия сервисов (упрощенно):
```mermaid
graph TD
    User[Пользователь] -- HTTPS/HTTP --> Caddy;

    subgraph "Внутренняя Docker Сеть (ai_stack_network)"
        Caddy -- /openwebui --> OpenWebUI;
        Caddy -- /flowise --> Flowise;
        Caddy -- /n8n --> n8n;
        Caddy -- /searxng --> SearXNG;
        Caddy -- /supabase --> Supabase_Kong[Supabase (Kong API Gateway)];
        Caddy -- /langfuse --> Langfuse_Web[Langfuse (Web UI)];

        OpenWebUI -- API запрос --> Ollama;
        Flowise -- API запрос --> Ollama;
        Flowise -- Векторный поиск/хранение --> Qdrant;
        Flowise -- Хранение данных/Auth --> Supabase_Kong;
        n8n -- Хранение данных/Автоматизация --> Supabase_Kong;
        n8n -- Векторный поиск/Автоматизация --> Qdrant;
        
        Langfuse_Web -- Сбор метрик/трейсов --> Langfuse_Worker[Langfuse Worker];
        Langfuse_Worker -- Запись данных --> Langfuse_Postgres[Langfuse PostgreSQL];
        Langfuse_Worker -- Запись данных --> Langfuse_ClickHouse[Langfuse ClickHouse];
        Langfuse_Worker -- Хранение объектов --> Langfuse_MinIO[Langfuse MinIO];
        
        %% Supabase внутренние взаимодействия (пример)
        Supabase_Kong --> Supabase_GoTrue[Supabase GoTrue (Auth)];
        Supabase_Kong --> Supabase_PostgREST[Supabase PostgREST (DB API)];
        Supabase_PostgREST --> Supabase_DB[Supabase PostgreSQL];
    end

    Ollama -- Хранение моделей --> Ollama_Models_Volume[Docker Volume (Модели Ollama)];
    Qdrant -- Хранение векторов --> Qdrant_Data_Volume[Docker Volume (Данные Qdrant)];
    Supabase_DB -- Хранение данных --> Supabase_Data_Volume[Docker Volume (Данные Supabase)];
    Langfuse_Postgres -- Хранение данных --> Langfuse_Postgres_Volume[Docker Volume (Данные Langfuse PG)];
    Langfuse_ClickHouse -- Хранение данных --> Langfuse_ClickHouse_Volume[Docker Volume (Данные Langfuse CH)];
    Langfuse_MinIO -- Хранение объектов --> Langfuse_MinIO_Volume[Docker Volume (Данные Langfuse MinIO)];